// FlowForge - Workflow Automation Platform
// Complete database schema for workflows, executions, and credentials

generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Auth relations
  sessions Session[]
  accounts Account[]

  // FlowForge relations
  workflows        Workflow[]
  credentials      Credential[]
  executions       Execution[]
  teamMembers      TeamMember[]
  workflowVersions WorkflowVersion[]
  auditLogs        AuditLog[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ============================================
// WORKFLOW AUTOMATION
// ============================================

model Workflow {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Workflow definition (stored as JSON)
  nodes    Json  @default("[]") // Array of node objects
  edges    Json  @default("[]") // Array of edge/connection objects
  viewport Json? // Canvas viewport state (zoom, position)
  settings Json? // Workflow settings (timezone, error handling, etc.)

  // Organization
  folder     String? // Folder path for organizing workflows
  tags       String[] @default([]) // Tags for filtering
  isFavorite Boolean  @default(false)

  // Error Alert Settings
  errorAlertEmail   String? // Email to notify on failure
  errorAlertSlack   String? // Slack webhook URL for alerts
  errorAlertEnabled Boolean @default(false)

  // Status
  isActive Boolean @default(false)
  version  Int     @default(1)

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Related entities
  executions Execution[]
  schedules  Schedule[]
  webhooks   WebhookEndpoint[]

  // Metadata
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  lastExecutedAt   DateTime?
  team             Team?             @relation("TeamWorkflows", fields: [teamId], references: [id])
  teamId           String?
  workflowVersions WorkflowVersion[]

  @@index([userId])
  @@index([isActive])
  @@map("workflow")
}

model Execution {
  id     String          @id @default(cuid())
  status ExecutionStatus @default(PENDING)
  mode   ExecutionMode   @default(MANUAL)

  // Timing
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  duration   Int? // Duration in milliseconds

  // Data
  inputData   Json? // Input data that triggered the execution
  outputData  Json? // Final output data
  nodeResults Json? // Results from each node { nodeId: { data, error, duration } }
  error       Json? // Error details if failed

  // Relationships
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  userId     String? // User who triggered (null for scheduled/webhook)
  user       User?    @relation(fields: [userId], references: [id])

  // Retry tracking
  retryOf    String?
  retryCount Int     @default(0)

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@map("execution")
}

model AuditLog {
  id        String  @id @default(cuid())
  action    String // CREATE, UPDATE, DELETE, EXECUTE, LOGIN, etc.
  entity    String // workflow, credential, team, etc.
  entityId  String? // ID of the affected entity
  details   Json? // Additional details about the action
  ipAddress String? // Client IP address
  userAgent String? // Browser/client user agent

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_log")
}

model Credential {
  id       String @id @default(cuid())
  name     String
  type     String // oauth2, apiKey, basic, bearer, etc.
  provider String // slack, github, google, custom, etc.

  // Encrypted credential data (JSON string encrypted with AES-256)
  data String

  // OAuth specific fields
  expiresAt    DateTime?
  refreshToken String?
  scope        String?
  metadata     Json? // Store extra provider-specific info

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime?

  @@unique([userId, name])
  @@index([userId])
  @@index([provider])
  @@map("credential")
}

model Schedule {
  id             String  @id @default(cuid())
  cronExpression String // Cron expression for scheduling
  timezone       String  @default("UTC")
  isActive       Boolean @default(true)

  // Workflow relation
  workflowId String   @unique
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Tracking
  nextRunAt DateTime?
  lastRunAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schedule")
}

model WebhookEndpoint {
  id       String     @id @default(cuid())
  path     String     @unique // Unique webhook path
  method   HttpMethod @default(POST)
  isActive Boolean    @default(true)

  // Security
  secretHash  String? // HMAC secret for signature verification
  ipAllowlist String[] // Allowed IP addresses (empty = all allowed)

  // Workflow relation
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Stats
  createdAt    DateTime  @default(now())
  lastCalledAt DateTime?
  callCount    Int       @default(0)

  @@index([workflowId])
  @@map("webhook_endpoint")
}

// ============================================
// ENUMS
// ============================================

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  ERROR
  CANCELLED
  WAITING
}

enum ExecutionMode {
  MANUAL
  SCHEDULED
  WEBHOOK
  TRIGGER
  SUBWORKFLOW
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// TEAMS & COLLABORATION
// ============================================

model Team {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   TeamMember[]
  workflows Workflow[]   @relation("TeamWorkflows")

  @@map("team")
}

model TeamMember {
  id   String   @id @default(cuid())
  role TeamRole @default(MEMBER)

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_member")
}

// ============================================
// WORKFLOW VERSIONING
// ============================================

model WorkflowVersion {
  id         String @id @default(cuid())
  versionNum Int

  // Snapshot of workflow at this version
  nodes    Json
  edges    Json
  viewport Json?
  settings Json?

  // Change tracking
  changeMessage String?

  // Relation to workflow
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Who made this version
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@unique([workflowId, versionNum])
  @@index([workflowId])
  @@map("workflow_version")
}
